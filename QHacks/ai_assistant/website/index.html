<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Truffle — AI Cat Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#f0a050;--accent-dim:rgba(240,160,80,.25);--accent-glow:rgba(240,160,80,.4);
      --glass:rgba(12,12,28,.78);--glass-light:rgba(22,22,48,.55);
      --border:rgba(240,160,80,.18);--text:#f0e8e0;--text-dim:#8a7a6a;
      --text-bright:#fff;--radius:18px;--radius-sm:12px;
      --font:'Inter',system-ui,sans-serif;--font-brand:'Space Grotesk',sans-serif;
      --red:#ff6b6b;--green:#4ade80;--pink:#ff9eaa;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden}
    body{font-family:var(--font);color:var(--text);background:#080814}
    canvas{display:block;position:fixed;inset:0;z-index:0}

    /* ── Gallery ───────────────────────────────── */
    #gallery{position:fixed;inset:0;z-index:45;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#14102a 0%,#0c0a1a 50%,#12101e 100%);transition:opacity .9s cubic-bezier(.4,0,.2,1)}
    #gallery.dismissed{opacity:0;pointer-events:none}
    .gallery-title{text-align:center;margin-bottom:44px;opacity:0;animation:fadeUp .8s .2s forwards}
    .gallery-title h1{font-family:var(--font-brand);font-size:clamp(30px,5vw,52px);color:var(--text-bright);margin-bottom:8px}
    .gallery-title h1 span{background:linear-gradient(135deg,var(--accent),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .gallery-title p{color:var(--text-dim);font-size:clamp(13px,2vw,17px)}
    .gallery-cards{display:flex;gap:28px;justify-content:center;flex-wrap:wrap;padding:0 20px}
    .gallery-card{width:240px;height:320px;border-radius:20px;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 50px rgba(0,0,0,.5);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .9s cubic-bezier(.4,0,.2,1),opacity .7s;opacity:0;animation:fadeUp .7s forwards}
    .gallery-card:nth-child(1){animation-delay:.3s}
    .gallery-card:nth-child(2){animation-delay:.5s}
    .gallery-card:nth-child(3){animation-delay:.7s}
    #gallery.dismissed .gallery-card:nth-child(1){transform:translateX(-160%) rotate(-12deg);opacity:0}
    #gallery.dismissed .gallery-card:nth-child(2){transform:translateY(-140%) scale(.85);opacity:0}
    #gallery.dismissed .gallery-card:nth-child(3){transform:translateX(160%) rotate(12deg);opacity:0}
    .card-emoji{font-size:90px;margin-bottom:14px;filter:drop-shadow(0 6px 16px rgba(0,0,0,.4))}
    .card-caption{font-family:var(--font-brand);font-size:15px;color:var(--text-bright);text-shadow:0 2px 8px rgba(0,0,0,.5)}
    .card-sub{font-size:11px;color:rgba(255,255,255,.45);margin-top:4px}
    @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    #gallery-scroll{position:absolute;bottom:36px;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--text-dim);font-size:12px;cursor:pointer;animation:bounceArrow 2s infinite;opacity:0;animation:bounceArrow 2s infinite,fadeUp .8s .9s forwards}
    #gallery-scroll svg{width:22px;height:22px;fill:var(--accent);opacity:.7}
    @keyframes bounceArrow{0%,100%{transform:translateY(0)}50%{transform:translateY(8px)}}

    /* ── Header ────────────────────────────────── */
    #header{position:fixed;top:0;left:0;right:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--border);opacity:0;transition:opacity .6s .2s;pointer-events:none}
    #header.visible{opacity:1;pointer-events:auto}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--pink));display:flex;align-items:center;justify-content:center;font-size:18px}
    .logo-text{font-family:var(--font-brand);font-size:20px;font-weight:700;color:var(--text-bright)}
    .logo-sub{font-size:12px;color:var(--text-dim);margin-left:2px}
    .btn-glass{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:var(--radius-sm);background:var(--glass-light);border:1px solid var(--border);color:var(--text);font-size:13px;font-family:var(--font);cursor:pointer;transition:all .2s}
    .btn-glass:hover{background:var(--accent-dim);border-color:var(--accent)}
    .btn-glass svg{width:16px;height:16px;fill:var(--accent)}

    /* ── Breed Toolbar ─────────────────────────── */
    #breed-toolbar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:8px;padding:10px 20px;background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:999px;opacity:0;transition:opacity .6s .4s;pointer-events:none}
    #breed-toolbar.visible{opacity:1;pointer-events:auto}
    .breed-btn{width:40px;height:40px;border-radius:50%;border:2.5px solid transparent;cursor:pointer;position:relative;transition:all .25s;display:flex;align-items:center;justify-content:center;background:none;padding:0}
    .breed-btn:hover{transform:scale(1.18);border-color:rgba(255,255,255,.35)}
    .breed-btn.selected{border-color:var(--accent);box-shadow:0 0 14px var(--accent-glow)}
    .breed-swatch{width:28px;height:28px;border-radius:50%;box-shadow:inset 0 -3px 6px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.2)}
    .breed-label{position:absolute;bottom:-20px;font-size:9px;white-space:nowrap;color:var(--text-dim);opacity:0;transition:opacity .2s;font-family:var(--font);pointer-events:none}
    .breed-btn:hover .breed-label{opacity:1}

    /* ── Chat ──────────────────────────────────── */
    #chat-container{position:fixed;bottom:80px;left:16px;width:min(380px,calc(50% - 24px));z-index:20;background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;box-shadow:0 8px 40px rgba(0,0,0,.4);max-height:50vh;opacity:0;transition:opacity .6s .3s;pointer-events:none}
    #chat-container.visible{opacity:1;pointer-events:auto}
    #chat-messages{flex:1;overflow-y:auto;padding:16px 16px 8px;display:flex;flex-direction:column;gap:10px;min-height:48px;max-height:36vh}
    #chat-messages::-webkit-scrollbar{width:5px}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--accent-dim);border-radius:4px}
    .message{display:flex;gap:10px;align-items:flex-start;animation:msgIn .3s ease}
    .message.user{justify-content:flex-end}
    .message-avatar{width:28px;height:28px;border-radius:8px;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--pink));display:flex;align-items:center;justify-content:center;font-size:14px}
    .message-content{padding:10px 14px;border-radius:14px;font-size:14px;line-height:1.5;max-width:80%;white-space:pre-line}
    .message.truffle .message-content{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .message.user .message-content{background:var(--accent-dim);border:1px solid rgba(240,160,80,.15)}
    @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .dots{display:flex;gap:5px;padding:4px 0}
    .dots span{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:dotPulse 1.2s infinite}
    .dots span:nth-child(2){animation-delay:.2s}
    .dots span:nth-child(3){animation-delay:.4s}
    @keyframes dotPulse{0%,100%{opacity:.3;transform:scale(.7)}50%{opacity:1;transform:scale(1.1)}}
    #chat-form{display:flex;gap:8px;padding:10px 14px;border-top:1px solid var(--border);align-items:center}
    #mic-btn{width:44px;height:44px;border-radius:50%;border:2px solid var(--border);background:transparent;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s;flex-shrink:0;position:relative}
    #mic-btn svg{width:20px;height:20px;fill:currentColor}
    #mic-btn:hover{border-color:var(--accent);color:var(--accent)}
    #mic-btn.listening{border-color:var(--red);color:var(--red);background:rgba(255,107,107,.12);animation:micPulse 1.5s infinite}
    #mic-btn.listening::after{content:'';position:absolute;inset:-6px;border-radius:50%;border:2px solid var(--red);opacity:.4;animation:micRing 1.5s infinite}
    @keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,107,107,.3)}50%{box-shadow:0 0 0 10px rgba(255,107,107,0)}}
    @keyframes micRing{0%{transform:scale(.9);opacity:.5}100%{transform:scale(1.4);opacity:0}}
    #chat-input{flex:1;padding:10px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);font-size:14px;font-family:var(--font);outline:none;transition:border-color .2s}
    #chat-input:focus{border-color:var(--accent)}
    #chat-input::placeholder{color:var(--text-dim)}
    #chat-input.listening{border-color:var(--red);color:var(--red)}
    #send-btn{width:42px;height:42px;border-radius:var(--radius-sm);border:none;background:var(--accent);color:#0a0a1e;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    #send-btn:hover{background:#f5b570;transform:scale(1.05)}
    #send-btn:disabled{opacity:.4;cursor:default;transform:none}
    #send-btn svg{width:18px;height:18px}
    #status-bar{padding:4px 14px 0;font-size:11px;color:var(--text-dim);min-height:18px;display:flex;align-items:center;gap:6px}
    .status-dot-sm{width:6px;height:6px;border-radius:50%;display:inline-block}
    .status-dot-sm.green{background:var(--green);animation:pulse-dot 2s infinite}
    .status-dot-sm.red{background:var(--red);animation:pulse-dot 1s infinite}
    @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}

    /* ── Voice Panel ───────────────────────────── */
    #voice-panel{position:fixed;top:0;right:0;bottom:0;width:min(380px,90vw);z-index:30;background:var(--glass);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border-left:1px solid var(--border);transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
    #voice-panel.open{transform:translateX(0)}
    .panel-header{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 14px;border-bottom:1px solid var(--border)}
    .panel-header h3{font-family:var(--font-brand);font-size:17px;color:var(--text-bright)}
    .btn-close{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:18px;cursor:pointer;transition:all .2s}
    .btn-close:hover{background:rgba(255,100,100,.15);border-color:rgba(255,100,100,.3);color:#ff8888}
    .voice-grid{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
    .voice-card{padding:14px 16px;border-radius:var(--radius-sm);border:1px solid var(--border);background:rgba(255,255,255,.03);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px}
    .voice-card:hover{background:var(--accent-dim);border-color:rgba(240,160,80,.3)}
    .voice-card.selected{background:var(--accent-dim);border-color:var(--accent)}
    .voice-card-top{display:flex;align-items:center;justify-content:space-between}
    .voice-name{font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
    .voice-gender{font-size:11px;padding:2px 7px;border-radius:6px;background:rgba(255,255,255,.08)}
    .voice-accent{font-size:11px;color:var(--text-dim)}
    .voice-desc{font-size:12px;color:var(--text-dim);line-height:1.4}
    .btn-preview{align-self:flex-start;margin-top:6px;padding:5px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--accent);font-size:11px;cursor:pointer;transition:all .2s;font-family:var(--font)}
    .btn-preview:hover{background:var(--accent-dim)}
    .btn-preview:disabled{opacity:.4;cursor:default}
    #overlay{position:fixed;inset:0;z-index:25;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .3s}
    #overlay.visible{opacity:1;pointer-events:auto}

    /* ── Permission Modal ──────────────────────── */
    #perm-modal{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
    #perm-modal.visible{opacity:1;pointer-events:auto}
    .perm-box{background:var(--glass);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:var(--radius);padding:32px;max-width:400px;text-align:center;display:flex;flex-direction:column;gap:16px}
    .perm-box h2{font-family:var(--font-brand);font-size:20px;color:var(--text-bright)}
    .perm-box p{font-size:14px;color:var(--text-dim);line-height:1.5}
    .perm-box .btn-accent{padding:12px 28px;border-radius:var(--radius-sm);border:none;background:var(--accent);color:#0a0a1e;font-size:15px;font-weight:600;font-family:var(--font);cursor:pointer;transition:all .2s}
    .perm-box .btn-accent:hover{background:#f5b570;transform:scale(1.03)}
    .perm-box .btn-skip{padding:8px 16px;border:none;background:transparent;color:var(--text-dim);font-size:13px;cursor:pointer;font-family:var(--font)}

    /* ── Loading ────────────────────────────────── */
    #loading{position:fixed;inset:0;z-index:55;background:#080814;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;transition:opacity .6s}
    #loading.hidden{opacity:0;pointer-events:none}
    .loader{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #loading p{color:var(--text-dim);font-size:14px}
  </style>
</head>
<body>

  <!-- ════════ Gallery (covers screen, dismisses on scroll/click) ════════ -->
  <div id="gallery">
    <div class="gallery-title">
      <h1>Meet <span>Truffle</span></h1>
      <p>The cat who inspired our AI companion</p>
    </div>
    <div class="gallery-cards">
      <div class="gallery-card" style="background:linear-gradient(145deg,#3d1f5c,#1a0f30)">
        <div class="card-emoji">&#x1F431;</div>
        <div class="card-caption">The Real Truffle</div>
        <div class="card-sub">Always curious</div>
      </div>
      <div class="gallery-card" style="background:linear-gradient(145deg,#1f3d5c,#0f1f30)">
        <div class="card-emoji">&#x1F63A;</div>
        <div class="card-caption">Cozy Moments</div>
        <div class="card-sub">Warm &amp; snuggly</div>
      </div>
      <div class="gallery-card" style="background:linear-gradient(145deg,#2d4a1f,#152510)">
        <div class="card-emoji">&#x1F408;</div>
        <div class="card-caption">Adventure Time</div>
        <div class="card-sub">Exploring the world</div>
      </div>
    </div>
    <div id="gallery-scroll">
      <span>Scroll down to meet Truffle</span>
      <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
  </div>

  <!-- ════════ Header ════════ -->
  <header id="header">
    <div class="logo">
      <div class="logo-icon">&#x1F43E;</div>
      <span class="logo-text">Truffle</span>
      <span class="logo-sub">AI Cat Assistant</span>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <button id="voice-btn" class="btn-glass">
        <span id="current-voice-name">Abigail</span>
        <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </button>
    </div>
  </header>

  <div id="overlay"></div>
  <div id="voice-panel">
    <div class="panel-header">
      <h3>Choose Truffle's Voice</h3>
      <button id="close-voice-panel" class="btn-close">&times;</button>
    </div>
    <div id="voice-list" class="voice-grid"></div>
  </div>

  <!-- ════════ Breed Toolbar ════════ -->
  <div id="breed-toolbar"></div>

  <!-- ════════ Permission Modal ════════ -->
  <div id="perm-modal">
    <div class="perm-box">
      <h2>Talk to Truffle &#x1F43E;</h2>
      <p>Truffle is your voice assistant. Click below to enable voice conversation &mdash; she'll listen to you and respond with her voice.</p>
      <p style="font-size:12px;color:var(--text-dim);margin-top:-8px">When your browser asks for microphone permission, click <strong>Allow</strong>.</p>
      <button id="perm-allow" class="btn-accent">Start Voice Chat</button>
      <button id="perm-skip" class="btn-skip">Type only (no microphone)</button>
    </div>
  </div>

  <!-- ════════ Chat ════════ -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <div id="status-bar"></div>
    <form id="chat-form" autocomplete="off">
      <button type="button" id="mic-btn" title="Toggle voice — click once to turn on, click again to turn off">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
      </button>
      <input type="text" id="chat-input" placeholder="Speak or type to Truffle..." autofocus>
      <button type="submit" id="send-btn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </form>
  </div>

  <div id="loading"><div class="loader"></div><p id="load-status">Waking up Truffle...</p></div>

  <!--
  ================================================================
  CORE APPLICATION SCRIPT (non-module)
  Handles: audio, mic STT, chat, TTS, voices, breeds, gallery
  Works independently of Three.js / 3D rendering.
  ================================================================
  -->
  <script>
  (function() {
    'use strict';

    // ── Breed catalog (shared with 3D module via window.BREEDS) ──
    var BREEDS = [
      { id:'ragdoll',  name:'Ragdoll',       body:0xf5f0eb, ear:0xd4c4a8, earIn:0xffc0cb, eye:0x6699cc, nose:0xffb6c1, paw:0xf0e0d0, tail:0xd4c4a8, collar:0xff6b6b },
      { id:'orange',   name:'Orange Tabby',  body:0xe8863a, ear:0xd07830, earIn:0xffa07a, eye:0x66aa44, nose:0xf4a460, paw:0xf0c0a0, tail:0xd07830, collar:0x64d8e0 },
      { id:'tuxedo',   name:'Tuxedo',        body:0x222233, ear:0x1a1a2e, earIn:0xffb6c1, eye:0x88cc44, nose:0x444455, paw:0xf0f0f0, tail:0x1a1a2e, collar:0xffd700 },
      { id:'siamese',  name:'Siamese',       body:0xfaf0e6, ear:0x6b4226, earIn:0xffc0cb, eye:0x4488cc, nose:0x8b6914, paw:0x6b4226, tail:0x6b4226, collar:0xff69b4 },
      { id:'calico',   name:'Calico',        body:0xfff8f0, ear:0xe8863a, earIn:0xffc0cb, eye:0x66aa44, nose:0xffb6c1, paw:0xe8863a, tail:0x222233, collar:0xa78bfa },
      { id:'russian',  name:'Russian Blue',  body:0x708090, ear:0x607080, earIn:0xdda0dd, eye:0x44aa66, nose:0x888899, paw:0x607080, tail:0x607080, collar:0x64d8e0 },
      { id:'white',    name:'White Persian', body:0xfafafa, ear:0xf0f0f0, earIn:0xffccd5, eye:0x4488cc, nose:0xffb6c1, paw:0xf0f0f0, tail:0xf0f0f0, collar:0xff69b4 },
      { id:'black',    name:'Black Cat',     body:0x1a1a2e, ear:0x151528, earIn:0x444466, eye:0xccaa00, nose:0x333355, paw:0x151528, tail:0x151528, collar:0xffd700 }
    ];
    window.BREEDS = BREEDS;
    var selectedBreed = 'ragdoll';

    function renderBreeds() {
      var tb = document.getElementById('breed-toolbar');
      tb.innerHTML = '';
      BREEDS.forEach(function(b) {
        var btn = document.createElement('button');
        btn.className = 'breed-btn' + (b.id === selectedBreed ? ' selected' : '');
        btn.title = b.name;
        var hex = '#' + b.body.toString(16).padStart(6, '0');
        btn.innerHTML = '<div class="breed-swatch" style="background:' + hex + '"></div><span class="breed-label">' + b.name + '</span>';
        btn.addEventListener('click', function() {
          selectedBreed = b.id;
          if (window.TruffleSetBreed) window.TruffleSetBreed(b);
          renderBreeds();
        });
        tb.appendChild(btn);
      });
    }
    renderBreeds();

    // ── Audio Manager ────────────────────────────
    var AudioMgr = {
      ctx: null, analyser: null, dataArray: null, isPlaying: false, unlocked: false, currentSource: null,
      ensure: function() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          this.analyser = this.ctx.createAnalyser();
          this.analyser.fftSize = 256;
          this.analyser.smoothingTimeConstant = 0.6;
          this.analyser.connect(this.ctx.destination);
          this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
      },
      unlock: function() {
        if (this.unlocked) return;
        this.ensure();
        try { var b=this.ctx.createBuffer(1,1,22050),s=this.ctx.createBufferSource();s.buffer=b;s.connect(this.ctx.destination);s.start(0); } catch(e){}
        this.unlocked = true;
      },
      playBlob: function(blob, onEnd) {
        var self = this; self.ensure();
        blob.arrayBuffer().then(function(buf){ return self.ctx.decodeAudioData(buf); })
        .then(function(audio){ var src=self.ctx.createBufferSource();src.buffer=audio;src.connect(self.analyser);self.isPlaying=true;self.currentSource=src;src.onended=function(){self.currentSource=null;self.isPlaying=false;if(onEnd)onEnd();};src.start(0); })
        .catch(function(e){ console.error('[AUDIO]',e);self.currentSource=null;self.isPlaying=false;if(onEnd)onEnd(); });
      },
      stopAudio: function() {
        if(this.currentSource){try{this.currentSource.stop(0);}catch(e){}}
        this.currentSource=null;this.isPlaying=false;
        if(window.speechSynthesis)speechSynthesis.cancel();
      },
      getVolume: function() {
        if (!this.analyser||!this.isPlaying) return 0;
        this.analyser.getByteFrequencyData(this.dataArray);
        var s=0;for(var i=0;i<this.dataArray.length;i++)s+=this.dataArray[i];
        return s/this.dataArray.length/255;
      }
    };
    window.RubyAudio = AudioMgr;

    function unlockAudioOnce(){AudioMgr.unlock();document.removeEventListener('click',unlockAudioOnce,true);document.removeEventListener('touchstart',unlockAudioOnce,true);}
    document.addEventListener('click', unlockAudioOnce, true);
    document.addEventListener('touchstart', unlockAudioOnce, true);

    // ── 3D bridge ────────────────────────────────
    window.RubyBot = { startTalking:function(){}, stopTalking:function(){}, setListening:function(){} };
    window.TruffleSetBreed = null;

    // ── Shared state ─────────────────────────────
    var chatHistory = [];
    var isProcessing = false;

    // ── Mic STT (getUserMedia → WAV → /api/stt) ─
    // Toggle mode: click once = ON (keeps listening after each response), click again = OFF
    var micStream=null,micAudioCtx=null,micProcessor=null,micSource=null,micChunks=[];
    var micActive=false,silenceStart=0;
    var micToggleOn=false;
    var micHasSpoken=false; // true once we detect any non-silent audio
    var SILENCE_THRESHOLD=0.012,SILENCE_TIMEOUT=2000,MAX_RECORD_MS=30000,micAutoTimer=null;

    function updateMicUI(){
      var btn=document.getElementById('mic-btn');
      var inp=document.getElementById('chat-input');
      if(micToggleOn){
        btn.classList.add('listening');
        if(micActive){inp.classList.add('listening');inp.placeholder='Listening... speak now';}
        else{inp.classList.remove('listening');inp.placeholder='Mic on — waiting to listen...';}
      }else{
        btn.classList.remove('listening');
        inp.classList.remove('listening');
        inp.placeholder='Speak or type to Truffle...';
      }
    }

    function startMicRecording(){
      if(micActive)return;
      if(isProcessing||AudioMgr.isPlaying)return;
      if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){setStatus('Voice input not supported. Use Chrome or Edge.','red');micToggleOn=false;updateMicUI();return;}
      setStatus('Listening... speak now','red');
      navigator.mediaDevices.getUserMedia({audio:{channelCount:1,echoCancellation:true,noiseSuppression:true,autoGainControl:true}})
      .then(function(stream){
        if(!micToggleOn){stream.getTracks().forEach(function(t){t.stop();});return;}
        micStream=stream;
        // Let the browser pick its native sample rate — we downsample later
        micAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
        console.log('[MIC] AudioContext sample rate:',micAudioCtx.sampleRate);
        micSource=micAudioCtx.createMediaStreamSource(stream);
        micProcessor=micAudioCtx.createScriptProcessor(4096,1,1);
        micChunks=[];micActive=true;silenceStart=0;micHasSpoken=false;
        micProcessor.onaudioprocess=function(e){
          if(!micActive)return;
          var d=e.inputBuffer.getChannelData(0);
          micChunks.push(new Float32Array(d));
          // Calculate RMS for silence detection
          var s=0;for(var i=0;i<d.length;i++)s+=d[i]*d[i];
          var rms=Math.sqrt(s/d.length);
          if(rms>=SILENCE_THRESHOLD){silenceStart=0;micHasSpoken=true;}
          else{
            // Only trigger silence-stop AFTER user has actually spoken
            if(micHasSpoken){
              if(!silenceStart)silenceStart=Date.now();
              else if(Date.now()-silenceStart>SILENCE_TIMEOUT&&micChunks.length>5){
                finishRecordingAndTranscribe();
              }
            }
          }
        };
        micSource.connect(micProcessor);micProcessor.connect(micAudioCtx.destination);
        updateMicUI();
        window.RubyBot.setListening(true);
        micAutoTimer=setTimeout(function(){if(micActive)finishRecordingAndTranscribe();},MAX_RECORD_MS);
      }).catch(function(err){
        micActive=false;micToggleOn=false;updateMicUI();
        if(err.name==='NotAllowedError'||err.name==='PermissionDeniedError'){setStatus('Microphone blocked — see instructions in chat','red');showMicHelp();}
        else if(err.name==='NotFoundError'){setStatus('No microphone found.','red');}
        else{setStatus('Mic error: '+err.message,'red');}
      });
    }

    function finishRecordingAndTranscribe(){
      if(!micActive)return;micActive=false;
      if(micAutoTimer){clearTimeout(micAutoTimer);micAutoTimer=null;}
      if(micStream){micStream.getTracks().forEach(function(t){t.stop();});micStream=null;}
      if(micProcessor){try{micProcessor.disconnect();}catch(e){}micProcessor=null;}
      if(micSource){try{micSource.disconnect();}catch(e){}micSource=null;}
      window.RubyBot.setListening(false);
      updateMicUI();
      if(!micHasSpoken||micChunks.length<3){
        setStatus('No speech detected — try again','red');
        closeMicCtx();
        if(micToggleOn)setTimeout(function(){startMicRecording();},400);
        return;
      }
      setStatus('Processing your speech...','green');
      // Merge all chunks
      var total=0;for(var i=0;i<micChunks.length;i++)total+=micChunks[i].length;
      var merged=new Float32Array(total);var off=0;
      for(var i=0;i<micChunks.length;i++){merged.set(micChunks[i],off);off+=micChunks[i].length;}
      micChunks=[];
      var nativeRate=micAudioCtx?micAudioCtx.sampleRate:48000;
      closeMicCtx();

      // Normalize audio levels — boost quiet speech to use full range
      var maxAmp=0;
      for(var i=0;i<merged.length;i++){var a=Math.abs(merged[i]);if(a>maxAmp)maxAmp=a;}
      if(maxAmp>0.01&&maxAmp<0.9){
        var gain=0.85/maxAmp;
        for(var i=0;i<merged.length;i++)merged[i]=Math.max(-1,Math.min(1,merged[i]*gain));
      }

      // Downsample to 16000 Hz for optimal Google Speech recognition
      var TARGET_RATE=16000;
      var finalSamples,finalRate;
      if(nativeRate!==TARGET_RATE&&nativeRate>TARGET_RATE){
        var ratio=nativeRate/TARGET_RATE;
        var newLen=Math.floor(merged.length/ratio);
        var downsampled=new Float32Array(newLen);
        for(var i=0;i<newLen;i++){
          var srcIdx=i*ratio;
          var idx=Math.floor(srcIdx);
          var frac=srcIdx-idx;
          var s0=merged[idx]||0;
          var s1=merged[idx+1]||0;
          downsampled[i]=s0+(s1-s0)*frac; // Linear interpolation
        }
        finalSamples=downsampled;finalRate=TARGET_RATE;
      }else{
        finalSamples=merged;finalRate=nativeRate;
      }

      var wavBlob=encodeWAV(finalSamples,finalRate);
      var durSec=(finalSamples.length/finalRate).toFixed(1);
      console.log('[MIC] Sending '+wavBlob.size+' bytes, '+durSec+'s at '+finalRate+'Hz');
      document.getElementById('chat-input').value='Processing...';
      fetch('/api/stt',{method:'POST',headers:{'Content-Type':'audio/wav'},body:wavBlob})
      .then(function(r){return r.json();}).then(function(data){
        document.getElementById('chat-input').value='';
        if(data.text&&data.text.trim()){
          console.log('[STT] Got:',data.text);
          handleSend(data.text.trim());
        }else{
          setStatus(data.error||'No speech detected — try again','red');
          if(micToggleOn)setTimeout(function(){startMicRecording();},400);
        }
      }).catch(function(e){
        document.getElementById('chat-input').value='';
        setStatus('Could not process speech — try again','red');
        console.error('[STT] Fetch error:',e);
        if(micToggleOn)setTimeout(function(){startMicRecording();},400);
      });
    }

    function stopMicCompletely(){
      micToggleOn=false;micActive=false;
      if(micAutoTimer){clearTimeout(micAutoTimer);micAutoTimer=null;}
      if(micStream){micStream.getTracks().forEach(function(t){t.stop();});micStream=null;}
      if(micProcessor){try{micProcessor.disconnect();}catch(e){}micProcessor=null;}
      if(micSource){try{micSource.disconnect();}catch(e){}micSource=null;}
      micChunks=[];
      window.RubyBot.setListening(false);
      updateMicUI();
      closeMicCtx();
      setStatus('Mic off — click mic or type to chat');
    }

    function autoResumeMic(){
      if(micToggleOn&&!micActive&&!isProcessing&&!AudioMgr.isPlaying){
        setTimeout(function(){startMicRecording();},150);
      }
    }

    function closeMicCtx(){if(micAudioCtx){try{micAudioCtx.close();}catch(e){}micAudioCtx=null;}}

    function encodeWAV(samples,sr){
      var l=samples.length,b=new ArrayBuffer(44+l*2),v=new DataView(b);
      function w(o,s){for(var i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}
      w(0,'RIFF');v.setUint32(4,36+l*2,true);w(8,'WAVE');w(12,'fmt ');
      v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);
      v.setUint32(24,sr,true);v.setUint32(28,sr*2,true);
      v.setUint16(32,2,true);v.setUint16(34,16,true);
      w(36,'data');v.setUint32(40,l*2,true);
      for(var i=0;i<l;i++){
        var s=Math.max(-1,Math.min(1,samples[i]));
        v.setInt16(44+i*2,s<0?s*0x8000:s*0x7FFF,true);
      }
      return new Blob([b],{type:'audio/wav'});
    }

    function showMicHelp(){addMsg("I couldn't access your microphone. Here's how to fix it:\n\n1. Windows Settings \u2192 Privacy & Security \u2192 Microphone \u2192 Turn ON\n2. Enable 'Let desktop apps access your microphone'\n3. In Chrome: click the lock icon in the address bar \u2192 Microphone \u2192 Allow\n4. Refresh this page\n\nYou can always type messages below!",false);}

    document.getElementById('mic-btn').addEventListener('click',function(){
      if(micToggleOn){stopMicCompletely();}
      else{micToggleOn=true;updateMicUI();startMicRecording();}
    });

    // ── Voice Management ─────────────────────────
    var voices=[];var selectedVoiceId='KRo-uwfno-KcEgBM';
    function loadVoices(){return fetch('/api/voices').then(function(r){return r.json();}).then(function(d){voices=d;renderVoices();}).catch(function(){});}
    function renderVoices(){
      var list=document.getElementById('voice-list');list.innerHTML='';
      voices.forEach(function(v){
        var card=document.createElement('div');card.className='voice-card'+(v.id===selectedVoiceId?' selected':'');
        card.innerHTML='<div class="voice-card-top"><div class="voice-name"><span class="voice-gender">'+(v.gender==='F'?'\u2640':'\u2642')+'</span>'+v.name+'</div><span class="voice-accent">'+v.accent+'</span></div><div class="voice-desc">'+v.desc+'</div><button class="btn-preview" data-vid="'+v.id+'">Preview</button>';
        card.addEventListener('click',function(e){if(e.target.classList.contains('btn-preview'))return;selectedVoiceId=v.id;document.getElementById('current-voice-name').textContent=v.name;renderVoices();});
        card.querySelector('.btn-preview').addEventListener('click',function(e){e.stopPropagation();var btn=e.target;btn.disabled=true;btn.textContent='...';speakText("Hi! I'm Truffle, nice to meet you!",v.id).then(function(){btn.disabled=false;btn.textContent='Preview';});});
        list.appendChild(card);
      });
    }
    document.getElementById('voice-btn').addEventListener('click',function(){document.getElementById('voice-panel').classList.add('open');document.getElementById('overlay').classList.add('visible');});
    function closeVP(){document.getElementById('voice-panel').classList.remove('open');document.getElementById('overlay').classList.remove('visible');}
    document.getElementById('close-voice-panel').addEventListener('click',closeVP);
    document.getElementById('overlay').addEventListener('click',closeVP);

    // ── TTS ──────────────────────────────────────
    function speakBrowser(text){return new Promise(function(resolve){if(!window.speechSynthesis){resolve();return;}speechSynthesis.cancel();var u=new SpeechSynthesisUtterance(text);u.rate=0.95;u.pitch=1.05;u.volume=1;var vv=speechSynthesis.getVoices();var p=vv.find(function(v){return v.lang.startsWith('en')&&v.name.toLowerCase().indexOf('female')>=0;})||vv.find(function(v){return v.lang.startsWith('en-US');})||vv.find(function(v){return v.lang.startsWith('en');});if(p)u.voice=p;u.onend=resolve;u.onerror=function(){resolve();};speechSynthesis.speak(u);});}
    function speakText(text,voiceId,speed,temp){
      speed=speed||0;temp=temp||0.7;AudioMgr.ensure();window.RubyBot.startTalking();
      // Send full text as one TTS call — Gradium renders natural pacing between sentences
      return fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,voice_id:voiceId||selectedVoiceId,speed:speed,temp:temp})})
      .then(function(r){if(!r.ok)throw new Error('TTS HTTP '+r.status);var ct=r.headers.get('content-type')||'';if(!ct.includes('audio'))throw new Error('Non-audio response');return r.blob();})
      .then(function(blob){if(blob.size<200)throw new Error('Audio too small');return new Promise(function(resolve){AudioMgr.playBlob(blob,resolve);});})
      .catch(function(e){setStatus('Using backup voice...','green');return speakBrowser(text);})
      .then(function(){window.RubyBot.stopTalking();});
    }
    window.RubySpeakText=speakText;

    // ── Chat Logic ───────────────────────────────
    function addMsg(text,isUser){var c=document.getElementById('chat-messages');var d=document.createElement('div');d.className='message '+(isUser?'user':'truffle');if(!isUser){var av=document.createElement('div');av.className='message-avatar';av.textContent='\uD83D\uDC3E';d.appendChild(av);}var ct=document.createElement('div');ct.className='message-content';ct.textContent=text;d.appendChild(ct);c.appendChild(d);c.scrollTop=c.scrollHeight;}
    function showThinking(){var c=document.getElementById('chat-messages');var d=document.createElement('div');d.className='message truffle';d.id='thinking';d.innerHTML='<div class="message-avatar">\uD83D\uDC3E</div><div class="message-content"><div class="dots"><span></span><span></span><span></span></div></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
    function hideThinking(){var el=document.getElementById('thinking');if(el)el.remove();}
    function setStatus(text,color){color=color||'green';var bar=document.getElementById('status-bar');bar.innerHTML=text?'<span class="status-dot-sm '+color+'"></span>'+text:'';}
    function handleSend(msg){
      if(!msg.trim())return;
      // Safe word: "stop truffle" — immediately stops voice and resets
      var lower=msg.trim().toLowerCase();
      if(lower==='stop truffle'||lower==='stop, truffle'||lower==='stop truffle.'){
        AudioMgr.stopAudio();
        window.RubyBot.stopTalking();
        isProcessing=false;
        document.getElementById('send-btn').disabled=false;
        setStatus('Stopped. Ready to chat.','green');
        addMsg(msg,true);
        addMsg("Got it, I'll stop. Let me know when you're ready to talk again.",false);
        if(micToggleOn){setTimeout(function(){startMicRecording();},400);}
        return;
      }
      if(isProcessing)return;isProcessing=true;document.getElementById('send-btn').disabled=true;document.getElementById('chat-input').value='';
      addMsg(msg,true);chatHistory.push({role:'user',content:msg});showThinking();setStatus('Truffle is thinking...');
      var reply="I'm having a little trouble right now, but I'm still here!";var ttsSpeed=0,ttsTemp=0.7;
      fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,history:chatHistory})})
      .then(function(r){if(r.ok)return r.json();throw new Error('Chat HTTP '+r.status);})
      .then(function(data){reply=data.reply||reply;ttsSpeed=data.tts_speed||0;ttsTemp=data.tts_temp||0.7;})
      .catch(function(e){setStatus('Connection issue','red');})
      .then(function(){hideThinking();addMsg(reply,false);chatHistory.push({role:'assistant',content:reply});setStatus('Truffle is speaking...');return speakText(reply,null,ttsSpeed,ttsTemp);})
      .then(function(){isProcessing=false;document.getElementById('send-btn').disabled=false;if(micToggleOn){setStatus('Listening... speak now','red');autoResumeMic();}else{setStatus('Ready \u2014 click mic or type');document.getElementById('chat-input').focus();}});
    }
    document.getElementById('chat-form').addEventListener('submit',function(e){e.preventDefault();e.stopPropagation();var inp=document.getElementById('chat-input');var msg=inp.value.trim();if(msg){inp.value='';handleSend(msg);}return false;});
    document.getElementById('chat-form').setAttribute('action','javascript:void(0)');

    // ── Gallery Dismiss ──────────────────────────
    var galleryDismissed=false;
    function dismissGallery(){
      if(galleryDismissed)return;galleryDismissed=true;
      document.getElementById('gallery').classList.add('dismissed');
      setTimeout(showUI,200);
    }
    function showUI(){
      document.getElementById('header').classList.add('visible');
      document.getElementById('chat-container').classList.add('visible');
      document.getElementById('breed-toolbar').classList.add('visible');
    }
    document.getElementById('gallery-scroll').addEventListener('click',dismissGallery);
    document.getElementById('gallery').addEventListener('wheel',function(e){if(e.deltaY>0)dismissGallery();},{passive:true});
    var _touchY=0;
    document.getElementById('gallery').addEventListener('touchstart',function(e){_touchY=e.touches[0].clientY;},{passive:true});
    document.getElementById('gallery').addEventListener('touchmove',function(e){if(_touchY-e.touches[0].clientY>50)dismissGallery();},{passive:true});

    // ── Permission Modal ─────────────────────────
    document.getElementById('perm-allow').addEventListener('click',function(){
      AudioMgr.unlock();document.getElementById('perm-modal').classList.remove('visible');
      setStatus('Speaking welcome...');addMsg("Hi! I'm Truffle, your cat assistant. Click the mic button to talk to me, or type below. I'll always respond with my voice!",false);
      speakText("Hi! I'm Truffle, your cat assistant. Click the mic button to talk to me, or type below.").then(function(){setStatus('Ready — click mic to start talking');micToggleOn=true;updateMicUI();setTimeout(function(){startMicRecording();},300);});
    });
    document.getElementById('perm-skip').addEventListener('click',function(){
      AudioMgr.unlock();document.getElementById('perm-modal').classList.remove('visible');
      addMsg("Hi! I'm Truffle. Type anything below and I'll respond with my voice. Click the mic button anytime to speak!",false);
      setStatus('Speaking welcome...');speakText("Hi! I'm Truffle. Type anything and I'll respond with my voice!").then(function(){setStatus('Ready \u2014 type below to chat');});
    });

    // ── Init ─────────────────────────────────────
    function coreInit(){
      var statusEl=document.getElementById('load-status');if(statusEl)statusEl.textContent='Loading voices...';
      fetch('/api/tts-check').then(function(r){return r.json();}).then(function(d){if(!d.ok)console.warn('[INIT] No TTS engines');}).catch(function(){});
      console.log('[INIT] getUserMedia:',navigator.mediaDevices?'supported':'NOT SUPPORTED');
      console.log('[INIT] SpeechSynthesis:',window.speechSynthesis?'supported':'NOT SUPPORTED');
      if(window.speechSynthesis){speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=function(){speechSynthesis.getVoices();};}
      var vp=loadVoices().catch(function(){});var to=new Promise(function(r){setTimeout(r,5000);});
      Promise.race([vp,to]).then(function(){
        if(statusEl)statusEl.textContent='Ready!';
        setTimeout(function(){var el=document.getElementById('loading');if(el)el.classList.add('hidden');},400);
        setTimeout(function(){var el=document.getElementById('perm-modal');if(el)el.classList.add('visible');},800);
      });
    }
    setTimeout(function(){var el=document.getElementById('loading');if(el&&!el.classList.contains('hidden')){el.classList.add('hidden');var pm=document.getElementById('perm-modal');if(pm)pm.classList.add('visible');}},10000);
    coreInit();
  })();
  </script>

  <!--
  ================================================================
  3D RENDERING MODULE — Truffle the Cat
  Loads Three.js locally from Flask static directory.
  ================================================================
  -->
  <script type="importmap">
  { "imports": {
      "three": "/static/js/three.module.js",
      "three/addons/": "/static/js/addons/"
  }}
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ── Truffle Cat 3D Model ──────────────────────
    class TruffleCat {
      constructor(breed) {
        this.group = new THREE.Group();
        this.isTalking = false;
        this.isListening = false;
        this.mouthOpen = 0;
        this.blinkTimer = 0;
        this.nextBlink = 2.5 + Math.random() * 3;
        this.isBlinking = false;
        this.blinkProgress = 0;
        this.idleState = 'normal';
        this.idleActionTimer = 0;
        this.nextIdleAction = 5 + Math.random() * 8;

        // References (set during build)
        this.headGroup = null;
        this.leftEarGroup = null;
        this.rightEarGroup = null;
        this.leftEyeGroup = null;
        this.rightEyeGroup = null;
        this.leftIris = null; this.rightIris = null;
        this.leftPupil = null; this.rightPupil = null;
        this.leftHL = null; this.rightHL = null;
        this.mouth = null;
        this.nose = null;
        this.legs = [];
        this.tailSegments = [];
        this.bell = null;
        this.whiskers = [];

        this._createMaterials(breed);
        this._build();
      }

      _createMaterials(b) {
        this.bodyMat = new THREE.MeshStandardMaterial({ color: b.body, roughness: 0.7, metalness: 0 });
        this.earMat = new THREE.MeshStandardMaterial({ color: b.ear, roughness: 0.7 });
        this.earInnerMat = new THREE.MeshStandardMaterial({ color: b.earIn, roughness: 0.5 });
        this.eyeWhiteMat = new THREE.MeshPhysicalMaterial({ color: 0xffffff, roughness: 0.1, clearcoat: 1.0 });
        this.irisMat = new THREE.MeshBasicMaterial({ color: b.eye });
        this.pupilMat = new THREE.MeshBasicMaterial({ color: 0x0a0a14 });
        this.noseMat = new THREE.MeshStandardMaterial({ color: b.nose, roughness: 0.4 });
        this.mouthMat = new THREE.MeshBasicMaterial({ color: 0x2a1a1a });
        this.whiskerMat = new THREE.MeshBasicMaterial({ color: 0xddddd0 });
        this.pawMat = new THREE.MeshStandardMaterial({ color: b.paw, roughness: 0.6 });
        this.tailMat = new THREE.MeshStandardMaterial({ color: b.tail, roughness: 0.7 });
        this.collarMat = new THREE.MeshStandardMaterial({ color: b.collar, roughness: 0.3, metalness: 0.2 });
        this.bellMat = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.2, metalness: 0.5 });
      }

      _build() {
        this._buildBody();
        this._buildHead();
        this._buildEars();
        this._buildEyes();
        this._buildNose();
        this._buildMouth();
        this._buildWhiskers();
        this._buildCheeks();
        this._buildLegs();
        this._buildTail();
        this._buildCollar();
      }

      _buildBody() {
        const g = new THREE.CapsuleGeometry(0.32, 0.28, 16, 32);
        const m = new THREE.Mesh(g, this.bodyMat);
        m.scale.set(1.1, 1.0, 1.05);  // chubby round body
        m.castShadow = true;
        this.group.add(m);
      }

      _buildHead() {
        this.headGroup = new THREE.Group();
        // Main head
        const hg = new THREE.SphereGeometry(0.4, 32, 32);
        const h = new THREE.Mesh(hg, this.bodyMat);
        h.scale.set(1.0, 0.95, 0.92);  // rounder, less horizontally stretched
        h.castShadow = true;
        this.headGroup.add(h);
        // Muzzle bump
        const mg = new THREE.SphereGeometry(0.12, 16, 16);
        const mz = new THREE.Mesh(mg, this.bodyMat);
        mz.scale.set(1, 0.6, 0.7);
        mz.position.set(0, -0.08, 0.3);
        this.headGroup.add(mz);
        // Cheek puffs
        const cg = new THREE.SphereGeometry(0.16, 16, 16);
        [-1, 1].forEach(s => {
          const c = new THREE.Mesh(cg, this.bodyMat);
          c.position.set(s * 0.2, -0.06, 0.2);
          c.scale.set(0.65, 0.6, 0.5);  // rounder cheeks
          this.headGroup.add(c);
        });
        this.headGroup.position.y = 0.75;
        this.group.add(this.headGroup);
      }

      _buildEars() {
        const oGeo = new THREE.ConeGeometry(0.13, 0.3, 4);
        const iGeo = new THREE.ConeGeometry(0.07, 0.19, 4);
        [[-1, 0.18], [1, -0.18]].forEach(([side, rotZ]) => {
          const eg = new THREE.Group();
          const outer = new THREE.Mesh(oGeo, this.earMat);
          eg.add(outer);
          const inner = new THREE.Mesh(iGeo, this.earInnerMat);
          inner.position.set(0, -0.02, 0.015);
          eg.add(inner);
          eg.position.set(side * 0.24, 0.38, -0.02);
          eg.rotation.z = rotZ;
          eg.rotation.x = 0.1;
          this.headGroup.add(eg);
          if (side === -1) this.leftEarGroup = eg;
          else this.rightEarGroup = eg;
        });
      }

      _buildEyes() {
        const build = (xSign) => {
          const g = new THREE.Group();
          // Sclera
          const sg = new THREE.SphereGeometry(0.1, 32, 32);
          const sc = new THREE.Mesh(sg, this.eyeWhiteMat);
          sc.scale.set(1.15, 1.0, 0.42);
          g.add(sc);
          // Iris
          const ig = new THREE.CircleGeometry(0.058, 32);
          const iris = new THREE.Mesh(ig, this.irisMat);
          iris.position.z = 0.043;
          g.add(iris);
          // Pupil (cat slit)
          const pg = new THREE.PlaneGeometry(0.022, 0.065);
          const pupil = new THREE.Mesh(pg, this.pupilMat);
          pupil.position.z = 0.044;
          g.add(pupil);
          // Highlight
          const hg = new THREE.CircleGeometry(0.016, 12);
          const hm = new THREE.MeshBasicMaterial({ color: 0xffffff });
          const hl = new THREE.Mesh(hg, hm);
          hl.position.set(0.02, 0.022, 0.045);
          g.add(hl);
          g.position.set(xSign * 0.155, 0.06, 0.3);
          this.headGroup.add(g);
          return { group: g, iris, pupil, hl };
        };
        const L = build(-1), R = build(1);
        this.leftEyeGroup = L.group; this.rightEyeGroup = R.group;
        this.leftIris = L.iris; this.rightIris = R.iris;
        this.leftPupil = L.pupil; this.rightPupil = R.pupil;
        this.leftHL = L.hl; this.rightHL = R.hl;
      }

      _buildNose() {
        const ng = new THREE.SphereGeometry(0.028, 12, 12);
        this.nose = new THREE.Mesh(ng, this.noseMat);
        this.nose.scale.set(1.3, 0.8, 0.6);
        this.nose.position.set(0, -0.06, 0.35);
        this.headGroup.add(this.nose);
      }

      _buildMouth() {
        const mg = new THREE.BoxGeometry(0.06, 0.012, 0.012);
        this.mouth = new THREE.Mesh(mg, this.mouthMat);
        this.mouth.position.set(0, -0.1, 0.33);
        this.headGroup.add(this.mouth);
      }

      _buildWhiskers() {
        const wg = new THREE.CylinderGeometry(0.002, 0.001, 0.22, 4);
        [-1, 1].forEach(side => {
          for (let i = 0; i < 3; i++) {
            const w = new THREE.Mesh(wg, this.whiskerMat);
            w.rotation.z = (Math.PI / 2) * side;
            w.rotation.x = (i - 1) * 0.12;
            w.position.set(side * 0.1, -0.065 + (i - 1) * 0.022, 0.3);
            this.headGroup.add(w);
            this.whiskers.push(w);
          }
        });
      }

      _buildCheeks() {
        const cg = new THREE.CircleGeometry(0.04, 16);
        const cm = new THREE.MeshBasicMaterial({ color: 0xff9999, transparent: true, opacity: 0.12 });
        [-1, 1].forEach(s => {
          const c = new THREE.Mesh(cg, cm);
          c.position.set(s * 0.24, -0.02, 0.32);
          this.headGroup.add(c);
        });
      }

      _buildLegs() {
        const lg = new THREE.CapsuleGeometry(0.07, 0.14, 8, 16);  // slightly thicker, shorter legs
        const pg = new THREE.SphereGeometry(0.075, 12, 12);
        // Front
        [{ x: -0.16, z: 0.1 }, { x: 0.16, z: 0.1 }].forEach(pos => {
          const grp = new THREE.Group();
          grp.add(new THREE.Mesh(lg, this.bodyMat));
          const paw = new THREE.Mesh(pg, this.pawMat);
          paw.position.y = -0.14;
          paw.scale.set(1, 0.65, 1.15);
          grp.add(paw);
          grp.position.set(pos.x, -0.4, pos.z);
          this.group.add(grp);
          this.legs.push(grp);
        });
        // Back
        [{ x: -0.19, z: -0.08 }, { x: 0.19, z: -0.08 }].forEach(pos => {
          const grp = new THREE.Group();
          grp.add(new THREE.Mesh(lg, this.bodyMat));
          const paw = new THREE.Mesh(pg, this.pawMat);
          paw.position.y = -0.14;
          paw.scale.set(1, 0.65, 1.15);
          grp.add(paw);
          grp.position.set(pos.x, -0.37, pos.z);
          this.group.add(grp);
          this.legs.push(grp);
        });
      }

      _buildTail() {
        const N = 12;
        for (let i = 0; i < N; i++) {
          const r = 0.042 - i * 0.0025;
          const seg = new THREE.Mesh(
            new THREE.SphereGeometry(Math.max(r, 0.012), 8, 8),
            this.tailMat
          );
          seg.castShadow = true;
          this.tailSegments.push(seg);
          this.group.add(seg);
        }
      }

      _buildCollar() {
        const cg = new THREE.TorusGeometry(0.25, 0.02, 12, 32);
        const collar = new THREE.Mesh(cg, this.collarMat);
        collar.rotation.x = Math.PI / 2;
        collar.position.y = 0.45;
        this.group.add(collar);
        const bg = new THREE.SphereGeometry(0.028, 12, 12);
        this.bell = new THREE.Mesh(bg, this.bellMat);
        this.bell.position.set(0, 0.43, 0.21);
        this.group.add(this.bell);
      }

      setBreed(b) {
        this.bodyMat.color.setHex(b.body);
        this.earMat.color.setHex(b.ear);
        this.earInnerMat.color.setHex(b.earIn);
        this.irisMat.color.setHex(b.eye);
        this.noseMat.color.setHex(b.nose);
        this.pawMat.color.setHex(b.paw);
        this.tailMat.color.setHex(b.tail);
        this.collarMat.color.setHex(b.collar);
      }

      update(time, delta, audioVol) {
        // ── Breathing ──
        const breathe = 1 + Math.sin(time * 1.5) * 0.012;
        this.group.children[0].scale.y = breathe;

        // ── Idle bob ──
        this.group.position.y = Math.sin(time * 0.8) * 0.02;
        this.group.rotation.z = Math.sin(time * 0.5) * 0.008;

        // ── Head ──
        if (this.isListening) {
          const tiltDir = Math.sin(time * 0.25) > 0 ? 1 : -1;
          const targetZ = tiltDir * 0.1;
          this.headGroup.rotation.z += (targetZ - this.headGroup.rotation.z) * delta * 1.5;
          this.headGroup.rotation.x += (0.04 - this.headGroup.rotation.x) * delta * 2;
        } else if (this.isTalking) {
          this.headGroup.rotation.x = Math.sin(time * 2.0) * 0.04;
          this.headGroup.rotation.z += (Math.sin(time * 1.5) * 0.03 - this.headGroup.rotation.z) * delta * 4;
        } else {
          this.headGroup.rotation.x += (Math.sin(time * 0.5) * 0.02 - this.headGroup.rotation.x) * delta * 3;
          this.headGroup.rotation.z += (Math.sin(time * 0.6) * 0.015 - this.headGroup.rotation.z) * delta * 3;
        }

        // ── Eyes ──
        const lx = Math.sin(time * 0.3) * 0.01;
        const ly = Math.cos(time * 0.45) * 0.007;
        [this.leftIris, this.rightIris].forEach(i => { if (i) { i.position.x = lx; i.position.y = ly; } });
        [this.leftPupil, this.rightPupil].forEach(p => { if (p) { p.position.x = lx; p.position.y = ly; } });
        [this.leftHL, this.rightHL].forEach(h => { if (h) { h.position.x = 0.02 + lx; h.position.y = 0.022 + ly; } });

        // ── Blink ──
        this.blinkTimer += delta;
        if (!this.isBlinking && this.blinkTimer >= this.nextBlink) {
          this.isBlinking = true; this.blinkProgress = 0;
        }
        if (this.isBlinking) {
          this.blinkProgress += delta / 0.12;
          let sy;
          if (this.blinkProgress < 0.5) sy = 1 - (this.blinkProgress / 0.5) * 0.95;
          else if (this.blinkProgress < 1) sy = 0.05 + ((this.blinkProgress - 0.5) / 0.5) * 0.95;
          else { sy = 1; this.isBlinking = false; this.blinkTimer = 0; this.nextBlink = 2 + Math.random() * 4; }
          if (this.leftEyeGroup) this.leftEyeGroup.scale.y = sy;
          if (this.rightEyeGroup) this.rightEyeGroup.scale.y = sy;
        }

        // ── Mouth ──
        if (this.isTalking && audioVol > 0.01) {
          this.mouthOpen += (Math.min(1, audioVol * 3.5) - this.mouthOpen) * 0.35;
        } else {
          this.mouthOpen += (0 - this.mouthOpen) * 0.12;
        }
        if (this.mouth) {
          this.mouth.scale.y = 0.5 + this.mouthOpen * 5;
          this.mouth.scale.x = 1 + this.mouthOpen * 0.3;
        }

        // ── Ears ──
        const earFwd = this.isListening ? -0.18 : 0;
        if (this.leftEarGroup) {
          this.leftEarGroup.rotation.x += (earFwd + 0.1 - this.leftEarGroup.rotation.x) * delta * 3;
          if (Math.random() < delta * 0.25) this.leftEarGroup.rotation.z = 0.18 + (Math.random() - 0.5) * 0.08;
        }
        if (this.rightEarGroup) {
          this.rightEarGroup.rotation.x += (earFwd + 0.1 - this.rightEarGroup.rotation.x) * delta * 3;
          if (Math.random() < delta * 0.18) this.rightEarGroup.rotation.z = -0.18 + (Math.random() - 0.5) * 0.08;
        }

        // ── Tail ──
        for (let i = 0; i < this.tailSegments.length; i++) {
          const t = i / this.tailSegments.length;
          const speed = this.isTalking ? 3.2 : this.isListening ? 1.8 : 1.0;
          const amp = this.isTalking ? 0.35 : 0.18;
          const sway = Math.sin(time * speed + t * 2.8) * amp * t;
          this.tailSegments[i].position.set(
            sway,
            0.05 + t * 0.4,
            -0.34 - t * 0.32
          );
        }

        // ── Legs ──
        if (this.legs.length >= 4) {
          const lm = this.isTalking ? Math.sin(time * 2.5) * 0.04 : 0;
          this.legs[0].rotation.x = lm;
          this.legs[1].rotation.x = -lm * 0.7;
        }

        // ── Bell swing ──
        if (this.bell) this.bell.position.x = Math.sin(time * 1.3) * 0.008;

        // ── Whisker twitch ──
        this.whiskers.forEach((w, i) => {
          w.rotation.x += (Math.sin(time * 2 + i) * 0.04 - w.rotation.x) * delta * 3;
        });

        // ── Idle special behaviors ──
        this._updateIdle(time, delta);
      }

      _updateIdle(time, delta) {
        if (this.isTalking || this.isListening) { this.idleState = 'normal'; return; }
        this.idleActionTimer += delta;

        if (this.idleState === 'normal') {
          if (this.idleActionTimer >= this.nextIdleAction) {
            const r = Math.random();
            if (r < 0.35) this.idleState = 'earWiggle';
            else if (r < 0.6) this.idleState = 'stretch';
            else if (r < 0.85) this.idleState = 'yawn';
            else this.idleState = 'pawLick';
            this.idleActionTimer = 0;
          }
        } else if (this.idleState === 'earWiggle') {
          if (this.idleActionTimer < 0.6) {
            const w = Math.sin(this.idleActionTimer * 28) * 0.18;
            if (this.leftEarGroup) this.leftEarGroup.rotation.z = 0.18 + w;
            if (this.rightEarGroup) this.rightEarGroup.rotation.z = -0.18 - w;
          } else { this.idleState = 'normal'; this.nextIdleAction = 5 + Math.random() * 8; }
        } else if (this.idleState === 'stretch') {
          const p = this.idleActionTimer / 3.0;
          if (p < 1) {
            const c = Math.sin(p * Math.PI);
            this.group.rotation.x = c * 0.07;
            if (this.legs[0]) { this.legs[0].rotation.x = c * 0.28; this.legs[1].rotation.x = c * 0.28; }
          } else {
            this.group.rotation.x = 0;
            if (this.legs[0]) { this.legs[0].rotation.x = 0; this.legs[1].rotation.x = 0; }
            this.idleState = 'normal'; this.nextIdleAction = 8 + Math.random() * 12;
          }
        } else if (this.idleState === 'yawn') {
          const p = this.idleActionTimer / 2.2;
          if (p < 1) {
            const c = Math.sin(p * Math.PI);
            if (this.mouth) { this.mouth.scale.y = 0.5 + c * 6; this.mouth.scale.x = 1 + c * 0.4; }
            this.headGroup.rotation.x += (c * -0.1 - this.headGroup.rotation.x) * delta * 5;
          } else {
            if (this.mouth) { this.mouth.scale.y = 0.5; this.mouth.scale.x = 1; }
            this.idleState = 'normal'; this.nextIdleAction = 10 + Math.random() * 15;
          }
        } else if (this.idleState === 'pawLick') {
          const p = this.idleActionTimer / 2.5;
          if (p < 1) {
            const c = Math.sin(p * Math.PI);
            if (this.legs[0]) this.legs[0].rotation.x = c * 0.5;
            this.headGroup.rotation.z += (c * 0.15 - this.headGroup.rotation.z) * delta * 4;
            this.headGroup.rotation.x += (c * 0.12 - this.headGroup.rotation.x) * delta * 4;
          } else {
            if (this.legs[0]) this.legs[0].rotation.x = 0;
            this.headGroup.rotation.z = 0; this.headGroup.rotation.x = 0;
            this.idleState = 'normal'; this.nextIdleAction = 8 + Math.random() * 14;
          }
        }
      }

      startTalking() { this.isTalking = true; this.isListening = false; }
      stopTalking() { this.isTalking = false; }
      setListening(v) { this.isListening = v; if (v) this.isTalking = false; }
    }

    // ── Scene Setup ──────────────────────────────
    try {
      const bgC = document.createElement('canvas');
      bgC.width = 2; bgC.height = 512;
      const bgX = bgC.getContext('2d');
      const gr = bgX.createLinearGradient(0, 0, 0, 512);
      gr.addColorStop(0, '#1a1530'); gr.addColorStop(0.5, '#0e0c1e'); gr.addColorStop(1, '#080814');
      bgX.fillStyle = gr; bgX.fillRect(0, 0, 2, 512);

      const scene = new THREE.Scene();
      scene.background = new THREE.CanvasTexture(bgC);

      const camera = new THREE.PerspectiveCamera(40, innerWidth / innerHeight, 0.1, 100);
      camera.position.set(0, 0.8, 3.6);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.3;
      document.body.prepend(renderer.domElement);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.06;
      controls.autoRotate = true; controls.autoRotateSpeed = 0.25;
      controls.minDistance = 2.2; controls.maxDistance = 5.5;
      controls.minPolarAngle = Math.PI * 0.3; controls.maxPolarAngle = Math.PI * 0.6;
      controls.enablePan = false; controls.target.set(0, 0.35, 0);

      // Lighting
      scene.add(new THREE.AmbientLight(0x504040, 0.6));
      const kl = new THREE.DirectionalLight(0xfff0e0, 1.2);
      kl.position.set(3, 5, 4); kl.castShadow = true;
      kl.shadow.mapSize.set(1024, 1024);
      kl.shadow.camera.near = 0.5; kl.shadow.camera.far = 15;
      kl.shadow.camera.left = -3; kl.shadow.camera.right = 3;
      kl.shadow.camera.top = 3; kl.shadow.camera.bottom = -3;
      scene.add(kl);
      const fl = new THREE.DirectionalLight(0x8888aa, 0.3); fl.position.set(-3, 3, 2); scene.add(fl);
      const rl = new THREE.DirectionalLight(0x6688aa, 0.4); rl.position.set(0, 2, -4); scene.add(rl);
      const bl = new THREE.PointLight(0xf0a050, 0.3, 5); bl.position.set(0, -1.2, 0); scene.add(bl);

      // Ground glow (warm)
      const gg = new THREE.Mesh(
        new THREE.CircleGeometry(1.2, 64),
        new THREE.MeshBasicMaterial({ color: 0xf0a050, transparent: true, opacity: 0.05 })
      );
      gg.rotation.x = -Math.PI / 2; gg.position.y = -0.62; scene.add(gg);

      // Floating particles
      const PC = 160, pp = new Float32Array(PC * 3);
      for (let i = 0; i < PC; i++) {
        pp[i * 3] = (Math.random() - 0.5) * 8;
        pp[i * 3 + 1] = (Math.random() - 0.5) * 6;
        pp[i * 3 + 2] = (Math.random() - 0.5) * 8;
      }
      const pGeo = new THREE.BufferGeometry();
      pGeo.setAttribute('position', new THREE.BufferAttribute(pp, 3));
      const particles = new THREE.Points(pGeo, new THREE.PointsMaterial({
        color: 0xf0a050, size: 0.016, transparent: true, opacity: 0.35, sizeAttenuation: true
      }));
      scene.add(particles);

      // Cat instance (default breed = ragdoll)
      const defaultBreed = window.BREEDS ? window.BREEDS[0] : { body:0xf5f0eb, ear:0xd4c4a8, earIn:0xffc0cb, eye:0x6699cc, nose:0xffb6c1, paw:0xf0e0d0, tail:0xd4c4a8, collar:0xff6b6b };
      const truffle = new TruffleCat(defaultBreed);
      scene.add(truffle.group);

      // Connect to core script
      window.RubyBot.startTalking = function() { truffle.startTalking(); };
      window.RubyBot.stopTalking = function() { truffle.stopTalking(); };
      window.RubyBot.setListening = function(v) { truffle.setListening(v); };
      window.TruffleSetBreed = function(breed) { truffle.setBreed(breed); };

      // Animation loop
      const clock = new THREE.Clock();
      function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        const time = clock.getElapsedTime();
        controls.update();
        const vol = window.RubyAudio ? window.RubyAudio.getVolume() : 0;
        truffle.update(time, delta, vol);
        particles.rotation.y = time * 0.02;
        renderer.render(scene, camera);
      }
      animate();

      window.addEventListener('resize', function() {
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
      });

      console.log('[3D] Truffle cat scene initialized');
    } catch (err) {
      console.error('[3D] Failed to init 3D scene:', err);
    }
  </script>
</body>
</html>
